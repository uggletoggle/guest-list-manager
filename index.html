<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gestor de Inscriptos</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body::before {
      content: "";
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: url('fondo.png') center center / cover no-repeat;
      opacity: 0.32;
      z-index: -1;
      pointer-events: none;
    }
    body > * {
      position: relative;
      z-index: 1;
    }
    /* Styles for the collapsible accordion functionality */
    .details-content {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.3s ease-in-out;
    }
    .collapsible.expanded .details-content {
      max-height: 500px; /* Adjust if content is taller */
    }
    .collapsible.expanded .chevron {
      transform: rotate(180deg);
    }
    .loader {
    border: 6px solid #f3f3f3; /* Gris claro */
    border-top: 6px solid #b08d57; /* Color principal */
    border-radius: 50%;
    width: 50px;
    height: 50px;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  </style>
</head>
<body class="bg-[#f9f7f4] text-[#3f3f3f] transition-colors duration-300">
  <div class="max-w-6xl mx-auto px-4 py-6">
    <div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-4 mb-6">
      <div class="flex flex-col sm:flex-row flex-wrap gap-2">
        <input id="search" type="text" placeholder="Buscar por nombre o apellido" class="border border-gray-300 rounded px-3 py-2 text-sm" />
        <select id="checkinFilter" class="border border-gray-300 rounded px-3 py-2 text-sm">
          <option value="all">Todos</option>
          <option value="false">Sin Check-in</option>
        </select>
        <span id="filterNotice" class="text-sm text-gray-500 ml-2"></span>
      </div>
      <div class="flex gap-2">
        <button onclick="downloadExcel()" class="px-4 py-2 bg-[#b08d57] text-white text-sm font-semibold rounded shadow">üì• Descargar Excel</button>
        <button id="addBtn" class="px-4 py-2 bg-[#b08d57] text-white text-sm font-semibold rounded shadow">‚ûï Agregar</button>
      </div>
    </div>

    <div class="min-w-full text-sm">
        <div class="hidden sm:flex text-[#b08d57] text-xs border-b border-[#ddd5c7] text-center font-bold">
            <div class="py-2 sm:w-[5%]" onclick="sortBy('numero_lista')">N¬∞ ‚¨ç</div>
            <div class="py-2 sm:w-[18%] cursor-pointer text-left" onclick="sortBy('nombre')">NOMBRE ‚¨ç</div>
            <div class="py-2 sm:w-[18%] cursor-pointer text-left" onclick="sortBy('apellido')">APELLIDO ‚¨ç</div>
            <div class="py-2 sm:w-[15%]">TIPO ENTRADA</div>
            <div class="py-2 sm:w-[10%]">MONTO</div>
            <div class="py-2 sm:w-[15%]">FECHA REGISTRO</div>
            <div class="py-2 sm:w-[5%]">CHECK-IN</div>
            <div class="py-2 sm:w-[14%]">ACCIONES</div>
        </div>
        <div id="guestBody" class="text-gray-700"></div>
    </div>
  </div>

  <div id="modal" class="fixed inset-0 bg-black bg-opacity-40 flex justify-center items-center z-50 invisible">
    <div class="bg-white p-6 rounded-md shadow-lg w-full max-w-md">
      <h3 id="modalTitle" class="text-lg font-semibold mb-4">Nuevo Inscripto</h3>
      <div class="flex flex-col gap-3">
        <input type="text" id="newNombre" placeholder="Nombre" class="border border-gray-300 rounded px-3 py-2" />
        <input type="text" id="newApellido" placeholder="Apellido" class="border border-gray-300 rounded px-3 py-2" />
        <input type="text" id="newEntrada" placeholder="Tipo Entrada" class="border border-gray-300 rounded px-3 py-2" />
        <input type="number" id="newMonto" placeholder="Monto" class="border border-gray-300 rounded px-3 py-2" />
        <div class="flex justify-end gap-2 mt-4">
          <button onclick="addGuest()" class="px-4 py-2 bg-[#b08d57] text-white rounded">Guardar</button>
          <button onclick="hideModal()" class="px-4 py-2 border rounded">Cancelar</button>
        </div>
      </div>
    </div>
  </div>
  <div id="loader-overlay" class="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-[100] hidden">
  <div class="loader"></div>
  <script>
    const SUPABASE_URL = 'https://bduenhilcuxbevnhwsnj.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJkdWVuaGlsY3V4YmV2bmh3c25qIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQzNzUzMjYsImV4cCI6MjA2OTk1MTMyNn0.Xu_Y9c4FzkTaU6rW02veEVvsSX7396Zj3ArxV69ZrDE';

    const clientSupabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    let guests = JSON.parse(localStorage.getItem('guests') || '[]');
    let sortKey = 'id';
    let sortAsc = true;

    function resetModalButton() {
      const saveBtn = document.querySelector('#modal button');
      saveBtn.textContent = 'Guardar';
      saveBtn.onclick = addGuest;
      document.getElementById('newNombre').value = '';
      document.getElementById('newApellido').value = '';
      document.getElementById('newEntrada').value = '';
      document.getElementById('newMonto').value = '';
    }

    function showModal(title = 'Nuevo Inscripto') {
      document.getElementById('modal').classList.remove('invisible');
      document.getElementById('modalTitle').textContent = title;
      resetModalButton();
    }

    document.getElementById('addBtn').addEventListener('click', function() {
      showModal('Nuevo Inscripto');
    });

    function saveGuests() {
      localStorage.setItem('guests', JSON.stringify(guests));
    }

    async function reordenarNumerosLista() {
    // 1. Obtener todos los inscriptos, ordenados por fecha de creaci√≥n.
    const { data: inscriptos, error } = await clientSupabase
        .from('inscriptos')
        .select('id')
        .order('created_at', { ascending: true });

    if (error) {
        console.error("Error al obtener lista para reordenar:", error);
        return;
    }

    // 2. Preparar los datos para la actualizaci√≥n masiva.
    const actualizaciones = inscriptos.map((inscripto, index) => ({
        id: inscripto.id,
        numero_lista: index + 1 // Asigna el nuevo n√∫mero de lista correlativo
    }));

    // 3. Ejecutar la actualizaci√≥n masiva (upsert).
    const { error: updateError } = await clientSupabase
        .from('inscriptos')
        .upsert(actualizaciones);

    if (updateError) {
        console.error("Error al actualizar n√∫meros de lista:", updateError);
    }
}

function showLoader() {
  document.getElementById('loader-overlay').classList.remove('hidden');
}

function hideLoader() {
  document.getElementById('loader-overlay').classList.add('hidden');
}
    // La funci√≥n principal se vuelve as√≠ncrona
async function renderGuests() {
    // 1. Obtiene los datos de Supabase, ordenados para una lista consistente.
    const { data: inscriptos, error } = await clientSupabase
        .from('inscriptos')
        .select('*')
        .order('created_at', { ascending: true }); // Ordenamos por fecha de creaci√≥n.

    if (error) {
        console.error('Error cargando inscriptos:', error);
        return;
    }

    // 2. Filtra los datos como antes.
    const search = document.getElementById('search').value.trim().toLowerCase();
    const checkinFilter = document.getElementById('checkinFilter').value;

    const filtered = inscriptos.filter(g => {
        const fullName = `${g.nombre || ''} ${g.apellido || ''}`;
        const matchName = fullName.toLowerCase().includes(search);
        const matchCheck = checkinFilter === 'all' || String(g.checkin) === checkinFilter;
        return matchName && matchCheck;
    });

    // 3. Renderiza el HTML.
    const body = document.getElementById('guestBody');
    body.innerHTML = ''; 

    filtered.forEach((g, index) => {
        // --- ¬°LA MAGIA EST√Å AQU√ç! ---
        // Se calcula el n√∫mero de lista usando el √≠ndice del array.
        // Se suma 1 porque los √≠ndices de los arrays empiezan en 0.
        const numeroDeLista = index + 1;
        // -----------------------------

        const row = document.createElement('div');
        row.className = `border-b border-[#ddd5c7] ${g.checkin ? 'bg-green-100' : 'bg-white/50'}`;
        
        const registrationDate = new Date(g.created_at).toLocaleDateString();

        // Los botones de acci√≥n siguen usando el 'g.id' real y permanente.
        const receiptButtonDesktop = g.comprobante_url ? `<button title="Ver Comprobante" onclick="event.stopPropagation(); viewReceipt('${g.comprobante_url}')">üìÑ</button>` : `<button title="Cargar Comprobante" onclick="event.stopPropagation(); uploadReceipt(${g.id})">üìé</button>`;
        const receiptButtonMobile = g.comprobante_url ? `<button onclick="viewReceipt('${g.comprobante_url}')" class="px-3 py-1 bg-gray-200 rounded text-xs mr-2">üìÑ Ver</button>` : `<button onclick="uploadReceipt(${g.id})" class="px-3 py-1 bg-gray-200 rounded text-xs mr-2">üìé Cargar</button>`;

        row.innerHTML = `
          <div class="collapsible">
            <div class="flex items-center w-full text-center cursor-pointer sm:cursor-default" onclick="this.parentElement.classList.toggle('expanded')">
              <div class="p-4 flex justify-between items-center sm:hidden w-full">
                <div>
                  <p class="font-bold text-left">${g.nombre} ${g.apellido}</p>
                  <p class="text-xs text-gray-500 text-left">N¬∞ ${numeroDeLista}</p>
                </div>
                <svg class="chevron w-4 h-4 transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path></svg>
              </div>
              <div class="hidden sm:flex sm:w-full sm:items-center text-sm">
                <div class="py-3 sm:w-[5%]">${numeroDeLista}</div>
                <div class="py-3 sm:w-[18%] text-left">${g.nombre}</div>
                <div class="py-3 sm:w-[18%] text-left">${g.apellido}</div>
                <div class="py-3 sm:w-[15%]">${g.entrada}</div>
                <div class="py-3 sm:w-[10%]">$${g.monto}</div>
                <div class="py-3 sm:w-[15%]">${registrationDate}</div>
                <div class="py-3 sm:w-[5%]"><input type="checkbox" onchange="toggleCheckin(${g.id}, ${g.checkin})" ${g.checkin ? 'checked' : ''}></div>
                <div class="py-3 sm:w-[14%] flex justify-center gap-4">
                  ${receiptButtonDesktop}
                  <button title="Editar" onclick="event.stopPropagation(); editGuest(${g.id})">‚úèÔ∏è</button>
                  <button title="Borrar" onclick="event.stopPropagation(); deleteGuest(${g.id})">üóëÔ∏è</button>
                </div>
              </div>
            </div>
            </div>
        `;
        body.appendChild(row);
    });
}
    function hideModal() {
      document.getElementById('modal').classList.add('invisible');
    }

async function addGuest() {
    // Obtiene los datos del formulario modal.
    const newGuestData = {
        nombre: document.getElementById('newNombre').value.trim(),
        apellido: document.getElementById('newApellido').value.trim(),
        entrada: document.getElementById('newEntrada').value.trim() || 'General',
        monto: parseFloat(document.getElementById('newMonto').value) || 0,
        checkin: false
    };

    // Validaci√≥n simple para asegurar que los campos principales no est√©n vac√≠os.
    if (!newGuestData.nombre || !newGuestData.apellido) {
        alert('El nombre y el apellido son obligatorios.');
        return;
    }

    showLoader(); // Muestra el indicador de carga.

    try {
        // Inserta el nuevo registro en la tabla 'inscriptos'.
        const { error } = await clientSupabase.from('inscriptos').insert(newGuestData);

        // Si Supabase devuelve un error, lo lanzamos para que lo capture el 'catch'.
        if (error) {
            throw error;
        }

        // Si todo fue exitoso, oculta el modal y refresca la lista.
        hideModal();
        renderGuests();

    } catch (error) {
        // Si ocurre cualquier error en el bloque 'try', lo muestra en la consola y alerta al usuario.
        console.error("Error al agregar inscripto:", error);
        alert("No se pudo agregar el inscripto: " + error.message);
    } finally {
        // Este bloque SIEMPRE se ejecuta, asegurando que el loader se oculte.
        hideLoader();
    }
}
    async function uploadReceipt(id) {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = 'image/*';

      input.onchange = async e => {
          const file = e.target.files[0];
          if (!file) return;

          // Inicia el proceso, muestra el loader
          showLoader();

          try {
              const cleanFileName = file.name.replace(/\s/g, '_');
              const filePath = `public/${id}-${cleanFileName}`;

              // 1. Subir el archivo
              const { data: uploadData, error: uploadError } = await clientSupabase.storage
                  .from('comprobantes')
                  .upload(filePath, file);

              if (uploadError) {
                  // Si hay un error, lo lanzamos para que lo capture el 'catch'
                  throw uploadError;
              }

              // 2. Obtener la URL p√∫blica
              const { data: urlData } = clientSupabase.storage
                  .from('comprobantes')
                  .getPublicUrl(uploadData.path);

              // 3. Actualizar la base de datos
              const { error: updateError } = await clientSupabase
                  .from('inscriptos')
                  .update({ comprobante_url: urlData.publicUrl })
                  .eq('id', id);

              if (updateError) {
                  throw updateError;
              }

              // Si todo fue exitoso, refresca la lista
              renderGuests();

          } catch (error) {
              // Si ocurre cualquier error en el bloque 'try', mu√©stralo
              console.error("Error en el proceso de subida:", error);
              alert("Hubo un error al subir el comprobante. Revisa la consola.");
          } finally {
              // El bloque 'finally' SIEMPRE se ejecuta, sin importar si hubo √©xito o error.
              // Es el lugar perfecto para ocultar el loader.
              hideLoader();
          }
      };

      input.click();
}

function viewReceipt(url) {
    window.open(url, '_blank');
}


    function editGuest(id) {
      const guest = guests.find(g => g.id === id);
      if (!guest) return;

      document.getElementById('newNombre').value = guest.nombre;
      document.getElementById('newApellido').value = guest.apellido;
      document.getElementById('newEntrada').value = guest.entrada;
      document.getElementById('newMonto').value = guest.monto;

      showModal('Editar Inscripto');

      const saveBtn = document.querySelector('#modal button[onclick^="addGuest"]');
      saveBtn.textContent = 'Actualizar';
      saveBtn.onclick = function() {
        guest.nombre = document.getElementById('newNombre').value.trim();
        guest.apellido = document.getElementById('newApellido').value.trim();
        guest.entrada = document.getElementById('newEntrada').value.trim();
        guest.monto = parseFloat(document.getElementById('newMonto').value) || 0;
        saveGuests();
        hideModal();
        renderGuests();
        resetModalButton();
      };
    }

    async function toggleCheckin(id, currentStatus) {
    const { error } = await clientSupabase
        .from('inscriptos')
        .update({ checkin: !currentStatus })
        .eq('id', id); // eq = equals (donde id sea igual a id)

    if (!error) renderGuests();
}

async function deleteGuest(id) {
    if (confirm('¬øEst√°s seguro de que quieres eliminar a este inscripto?')) {
        showLoader();
        try {
            const { error } = await clientSupabase.from('inscriptos').delete().eq('id', id);
            if (error) throw error;
            
            // Simplemente refresca la lista. El n√∫mero se recalcular√° solo.
            renderGuests();
        } catch (error) {
            console.error("Error al borrar:", error);
            alert("No se pudo eliminar el inscripto: " + error.message);
        } finally {
            hideLoader();
        }
    }
}
    function downloadExcel() {
      // --- MODIFICADO: A√±adir columna "Comprobante" al CSV ---
      let csvContent = 'ID,Nombre,Apellido,Tipo Entrada,Monto,Fecha Registro,Check-in,Comprobante\n';
      guests.forEach(g => {
        const row = [
            g.id, g.nombre, g.apellido, g.entrada, g.monto, g.fecha, g.checkin,
            g.comprobante ? 'Si' : 'No'
        ].join(',');
        csvContent += row + '\n';
      });

      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', 'inscriptos.csv');
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    document.getElementById('search').addEventListener('input', renderGuests);
    document.getElementById('checkinFilter').addEventListener('change', renderGuests);
    window.addEventListener('load', renderGuests);
  </script>

</div>
</body>
</html>